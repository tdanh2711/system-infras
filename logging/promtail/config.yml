# =============================================================================
# PROMTAIL CONFIGURATION
# =============================================================================
# Collects logs from Docker containers and forwards to Loki
# Uses Docker service discovery to auto-detect containers

server:
  http_listen_port: 9080
  grpc_listen_port: 0
  log_level: warn

# =============================================================================
# POSITIONS - Track read positions for each log file
# =============================================================================
positions:
  filename: /tmp/positions.yaml

# =============================================================================
# CLIENTS - Loki connection
# =============================================================================
clients:
  - url: http://system-loki:3100/loki/api/v1/push
    tenant_id: ""
    batchwait: 1s
    batchsize: 1048576
    timeout: 10s

# =============================================================================
# SCRAPE CONFIGS - Log collection rules
# =============================================================================
scrape_configs:
  # ===========================================================================
  # Docker Container Logs via Docker API
  # ===========================================================================
  - job_name: docker
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          # Only collect logs from containers with labels
          # Exclude system-infras containers by default
          - name: label
            values: ["logging=true"]

    relabel_configs:
      # Keep container name
      - source_labels: ['__meta_docker_container_name']
        regex: '/?(.*)'
        target_label: container

      # Extract project name (everything before first hyphen)
      - source_labels: ['__meta_docker_container_name']
        regex: '/?([^-]+)-.*'
        target_label: project

      # Extract service name (everything after first hyphen)
      - source_labels: ['__meta_docker_container_name']
        regex: '/?[^-]+-(.+)'
        target_label: service

      # Add compose project label if available
      - source_labels: ['__meta_docker_container_label_com_docker_compose_project']
        target_label: compose_project

      # Add compose service label if available
      - source_labels: ['__meta_docker_container_label_com_docker_compose_service']
        target_label: compose_service

      # Set job name based on project
      - source_labels: ['project']
        target_label: job

    pipeline_stages:
      # Try to parse JSON logs
      - json:
          expressions:
            level: level
            msg: msg
            message: message
            time: time
            timestamp: timestamp

      # Fallback: extract level from text logs
      - regex:
          expression: '(?P<level>DEBUG|INFO|WARN|WARNING|ERROR|FATAL|CRITICAL)'

      # Normalize log levels
      - template:
          source: level
          template: '{{ ToLower .Value }}'

      # Add extracted fields as labels
      - labels:
          level:

      # Timestamp parsing (multiple formats)
      - timestamp:
          source: time
          format: RFC3339
          fallback_formats:
            - RFC3339Nano
            - UnixMs
            - '2006-01-02T15:04:05.000Z'
            - '2006-01-02 15:04:05'

  # ===========================================================================
  # Docker Container Logs via File (Fallback/All containers)
  # ===========================================================================
  - job_name: docker-files
    static_configs:
      - targets:
          - localhost
        labels:
          job: docker-logs
          __path__: /var/lib/docker/containers/*/*-json.log

    relabel_configs:
      # Extract container ID from path
      - source_labels: ['__path__']
        regex: '/var/lib/docker/containers/([^/]+)/.*'
        target_label: container_id

    pipeline_stages:
      # Parse Docker JSON log format
      - json:
          expressions:
            stream: stream
            log: log
            time: time

      # Extract the actual log message
      - output:
          source: log

      # Parse container name from Docker labels in the log
      - json:
          expressions:
            attrs: attrs
          source: log

      # Try to parse the inner log as JSON
      - json:
          expressions:
            level: level
            msg: msg
            message: message
          source: log

      # Fallback: extract level from text
      - regex:
          expression: '(?P<level>DEBUG|INFO|WARN|WARNING|ERROR|FATAL|CRITICAL)'
          source: log

      # Normalize levels
      - template:
          source: level
          template: '{{ ToLower .Value }}'

      - labels:
          stream:
          level:

      - timestamp:
          source: time
          format: RFC3339Nano

  # ===========================================================================
  # System Infrastructure Logs (Optional)
  # ===========================================================================
  - job_name: system-infras
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 15s
        filters:
          - name: name
            values: ["system-*"]

    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        regex: '/?(.*)'
        target_label: container

      - source_labels: ['__meta_docker_container_name']
        regex: '/?system-(.*)'
        target_label: service

      - replacement: 'system-infras'
        target_label: project

      - replacement: 'system'
        target_label: job

    pipeline_stages:
      - json:
          expressions:
            level: level
            msg: msg

      - regex:
          expression: '(?P<level>DEBUG|INFO|WARN|WARNING|ERROR|FATAL|CRITICAL)'

      - labels:
          level:
