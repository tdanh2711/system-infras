# =============================================================================
# CADDY CONFIGURATION - SYSTEM INFRASTRUCTURE
# =============================================================================
# This Caddyfile handles:
# - Automatic import of project configs from /etc/caddy/projects/
# - Shared snippets (basic_auth) for all projects
# - Automatic HTTPS via Let's Encrypt
#
# Projects add their own Caddy configs by symlinking to caddy-projects/

# =============================================================================
# GLOBAL OPTIONS
# =============================================================================
{
    # Email for Let's Encrypt notifications (from .env)
    email {$ADMIN_EMAIL}

    # Uncomment for staging certificates during testing
    # acme_ca https://acme-staging-v02.api.letsencrypt.org/directory

    # Admin API (internal only, bound in docker-compose)
    admin 0.0.0.0:2019
}

# =============================================================================
# SNIPPET: Basic Auth
# =============================================================================
# Reusable basic auth block - projects can use: import basic_auth
# Password hash generated with: caddy hash-password
(basic_auth) {
    basicauth {
        # Username: admin
        # Generate new hash: docker exec system-caddy caddy hash-password
        admin {$CADDY_BASIC_AUTH_HASH}
    }
}

# =============================================================================
# IMPORT PROJECT CONFIGS
# =============================================================================
# Import all .caddy files from projects directory
# Each project manages its own config file
# Note: ? is a glob wildcard in Caddy, not "optional" modifier
import /etc/caddy/projects/*.caddy

# =============================================================================
# OPTIONAL: Health check endpoint
# =============================================================================
# Useful for load balancer health checks
# :8080 {
#     respond /health "OK" 200
# }
